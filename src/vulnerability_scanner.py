# src/vulnerability_scanner.py
# Nuclei Vulnerability Scanning Engine
# Digital Sentinel v6 - STEP 4

import os
import subprocess
from datetime import datetime

class VulnerabilityScanner:
    def __init__(self):
        base_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
        self.input_dir = os.path.join(base_dir, "data", "results", "crawler")
        self.results_dir = os.path.join(base_dir, "data", "results", "vulnscan")
        os.makedirs(self.results_dir, exist_ok=True)

    def run_scan(self, target):
        input_file = os.path.join(self.input_dir, f"{target}_katana.txt")
        output_file = os.path.join(self.results_dir, f"{target}_nuclei.json")

        if not os.path.exists(input_file):
            print(f"‚ö†Ô∏è No crawler results found for {target}")
            return None

        print(f"üß† Running Nuclei Vulnerability Scan on {target} ...")
        cmd = f"nuclei -l {input_file} -o {output_file} -json -severity critical,high,medium"

        try:
            subprocess.run(cmd, shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            print(f"‚úÖ Vulnerability scan complete for {target}")
        except Exception as e:
            print(f"‚ùå Error running Nuclei: {e}")

        return output_file
