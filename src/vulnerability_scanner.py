# ============================================================
# Digital Sentinel v6 - Vulnerability Scanner
# Author: Themoralhack & Manus AI
# Mission: Scan crawled URLs for common security issues.
# ============================================================

import re
import concurrent.futures
import requests

COMMON_VULN_PATTERNS = {
    "xss": [r"<script>", r"alert\(", r"onerror="],
    "sql_injection": [r"'", r"\" OR 1=1", r"UNION SELECT"],
    "open_redirect": [r"redirect=", r"next=", r"url="]
}

def scan_single_url(url):
    """Simple passive vulnerability pattern matcher."""
    findings = []
    try:
        response = requests.get(url, timeout=6)
        body = response.text.lower()

        for vuln_type, patterns in COMMON_VULN_PATTERNS.items():
            for p in patterns:
                if re.search(p.lower(), body):
                    findings.append(vuln_type)
                    break
    except Exception:
        pass

    return {"url": url, "findings": list(set(findings))}


def run_vulnerability_scan_batch(crawling_results):
    """Run vulnerability checks for all crawled URLs."""
    all_urls = []
    for item in crawling_results:
        all_urls.extend(item.get("urls", []))

    print(f"[üß©] Running vulnerability scan on {len(all_urls)} URLs...")
    results = []

    with concurrent.futures.ThreadPoolExecutor(max_workers=20) as executor:
        futures = [executor.submit(scan_single_url, url) for url in all_urls]
        for f in concurrent.futures.as_completed(futures):
            try:
                results.append(f.result())
            except Exception as e:
                print(f"[‚ö†Ô∏è] Vulnerability scan thread error: {e}")

    print(f"[üîê] Scan completed. {sum(1 for r in results if r['findings'])} URLs show possible issues.")
    return results
