name: ğŸ›°ï¸ Digital Sentinel Autonomous Cycle

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"   # â±ï¸ Ø±Û•ÙˆØ§Ù†Û•Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¦Û†ØªÛ†Ù…Ø§ØªÛŒÚ©ÛŒ Ù‡Û•Ù…ÙˆÙˆ 30 Ø®ÙˆÙ„Û•Ú© Ø¬Ø§Ø±ÛÚ©

jobs:
  run-sentinel:
    name: âš™ï¸ Launch Quantum Sentinel Autonomous Mode
    runs-on: ubuntu-latest

    env:
      # ğŸ§© Secrets (Loaded from GitHub Repository Secrets)
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # ====================================================
      # 1ï¸âƒ£ Checkout source code
      # ====================================================
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # ====================================================
      # 2ï¸âƒ£ Setup Python environment
      # ====================================================
      - name: ğŸ§  Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ====================================================
      # 3ï¸âƒ£ Install dependencies
      # ====================================================
      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "âš ï¸ No requirements.txt found, skipping."

      # ====================================================
      # 4ï¸âƒ£ Launch Main Quantum Controller
      # ====================================================
      - name: ğŸš€ Launch Main Quantum Controller
        run: |
          echo "=============================================="
          echo "ğŸš€ Running Digital Sentinel Quantum v11.4"
          echo "=============================================="
          python src/main_controller_v11_4_quantum.py

      # ====================================================
      # 5ï¸âƒ£ Upload Logs
      # ====================================================
      - name: ğŸ§¾ Upload Sentinel Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-logs
          path: |
            data/results/final_reports/
            logs/
          retention-days: 3

      # ====================================================
      # 6ï¸âƒ£ Discord Notification
      # ====================================================
      - name: ğŸ“¡ Dispatch Discord Report
        if: always()
        run: |
          echo "=============================================="
          echo "ğŸ“¡ Preparing Discord report dispatch..."
          echo "=============================================="
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "âš ï¸ Discord Webhook not configured. Skipping report dispatch."
          else
            REPORT_FILE=$(ls -t data/results/final_reports/*.json | head -n 1)
            echo "ğŸ“¨ Sending report: $REPORT_FILE"
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"ğŸ“Š **Digital Sentinel Quantum Report Completed!**\nğŸ•’ Cycle finished successfully.\nğŸ“ Report: $REPORT_FILE\"}" \
                 "$DISCORD_WEBHOOK_URL"
          fi

      # ====================================================
      # 7ï¸âƒ£ Watchdog Loop
      # ====================================================
      - name: ğŸº Watchdog Auto-Loop
        if: always()
        run: |
          echo "ğŸº Watchdog is active â€“ Sentinel will relaunch in 30 minutes"
