name: ğŸ§  Digital Sentinel Quantum v12 â€“ Intelligent Continuous Mode

on:
  workflow_dispatch:
  schedule:
    - cron: "*/20 * * * *"   # ğŸ” Ù‡Û•Ù…ÙˆÙˆ 20 Ø®ÙˆÙ„Û•Ú© Ø¬Ø§Ø±ÛÚ© cycle Ù†ÙˆÛ Ø¯Û•Ø³ØªÙ¾ÛØ¯Û•Ú©Ø§Øª

jobs:
  run-intelligent-cycle:
    name: âš™ï¸ Run Intelligent Continuous Sentinel
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # ====================================================
      # 1ï¸âƒ£ Checkout repository
      # ====================================================
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # ====================================================
      # 2ï¸âƒ£ Setup Python Environment
      # ====================================================
      - name: ğŸ§  Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ====================================================
      # 3ï¸âƒ£ Install Dependencies
      # ====================================================
      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "âš ï¸ No requirements.txt found"

      # ====================================================
      # 4ï¸âƒ£ Launch Quantum Intelligent Controller
      # ====================================================
      - name: ğŸš€ Launch Main Quantum v12 Controller
        run: |
          echo "===================================================="
          echo "ğŸš€ Running Digital Sentinel Quantum v12 (Intelligent Continuous Mode)"
          echo "===================================================="
          python src/main_controller_v12_intelligent.py

      # ====================================================
      # 5ï¸âƒ£ Upload Logs and Reports
      # ====================================================
      - name: ğŸ§¾ Upload Sentinel Reports & Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-v12-reports
          path: |
            data/results/final_reports/
            logs/
          retention-days: 5

      # ====================================================
      # 6ï¸âƒ£ Dispatch Advanced Discord Notification
      # ====================================================
      - name: ğŸ“¡ Dispatch AI Discord Report
        if: always()
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "âš ï¸ Discord Webhook not configured!"
          else
            REPORT_FILE=$(ls -t data/results/final_reports/*.json | head -n 1)
            echo "ğŸ“¨ Sending AI report: $REPORT_FILE"
            TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            PAYLOAD=$(jq -n --arg time "$TIME" --arg file "$REPORT_FILE" \
            '{embeds: [{title: "ğŸ§  Digital Sentinel Quantum v12 â€“ Report Completed",
                        description: "Cycle completed successfully.",
                        color: 5814783,
                        fields: [
                          {"name": "ğŸ•’ Time", "value": $time, "inline": true},
                          {"name": "ğŸ“ Report", "value": $file, "inline": false},
                          {"name": "âš™ï¸ Mode", "value": "Intelligent Continuous Scan", "inline": true}
                        ],
                        footer: {"text": "Digital Sentinel v12 â€“ Adaptive AI Recon"}]}')
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "$PAYLOAD" \
                 "$DISCORD_WEBHOOK_URL"
          fi

      # ====================================================
      # 7ï¸âƒ£ Adaptive Watchdog (Smart Relaunch)
      # ====================================================
      - name: ğŸº Adaptive Watchdog
        if: always()
        run: |
          echo "ğŸº [WATCHDOG] Intelligent Mode Active â€“ evaluating next run..."
          sleep 5
          echo "ğŸ“ˆ [ANALYZER] Checking if new targets exist..."
          if [ -f "data/targets.txt" ]; then
            COUNT=$(cat data/targets.txt | wc -l)
            if [ "$COUNT" -gt 0 ]; then
              echo "ğŸ’¡ [SCHEDULER] $COUNT targets found â€“ scheduling next cycle..."
            else
              echo "âš ï¸ [SCHEDULER] No targets detected â€“ awaiting next CRON wakeup."
            fi
          fi
